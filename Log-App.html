<!doctype html>
<html>

<head>
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Log App</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
</head>

<body>
  <nav>
    <div class="nav-wrapper teal">

      <a href="#" class="brand-logo">Log App</a>

    </div>
  </nav>


  <div id="content">

    <style>

    </style>

    <div class="container">

      <h1>Create</h1>

      <form class="col" onsubmit="createLog(event)">
        <div class="row">
          <div class="input-field col s12">
            <input placeholder="Placeholder" name="studentId" id="stdid" type="text" class="validate">
            <label for="first_name">Id Number</label>
          </div>
        </div>

        <div class="row">
          <select name="stream" class="input-field col s12">
            <option value="1">Stream 1</option>
            <option value="2">Stream 2</option>
            <option value="3">Stream 3</option>
          </select>
          <label>Materialize Select</label>
        </div>

        <div class="row">

          <button class="btn waves-effect waves-light col s4"" type=" submit">Submit
            <i class="material-icons right">send</i>
          </button>

        </div>

      </form>

      <table>
        <thead>
          <th>ID </th>
          <th>ID Number</th>
          <th>Date</th>
          <th>Stream</th>
          <th>Actions</th>
        </thead>
        <tbody id="logsTable">

        <tbody>
      </table>

    </div>

    <script>
      const server = 'https://exercise-js.snickdx.repl.co';

      document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('select');
        var instances = M.FormSelect.init(elems);
        getLogs();
      });

      async function sendRequest(url, method, data) {
        const options = { method };
        if (data) {
          options.body = JSON.stringify(data);
          options.headers = { 'Content-Type': 'application/json' };
        }
        let response = await fetch(server + url, options);
        return response.json();
      }

      async function createLog(event) {
        event.preventDefault();

        //Getting data from form
        const form = event.target;                //1. Get form
        const formData = new FormData(form);      //2. Create FormData object
        const data = Object.fromEntries(formData);//3. Create json object

        //It is important to await here so the data is sent before we reload the table 
        await sendRequest('/api/logs', 'POST', data);

        //Reload the table 
        getLogs();
      }

      async function getLogs() {
        const logs = await sendRequest('/api/logs', 'GET');
        displayLogs(logs);
      }
      // Drawing table on the dom
      function displayLogs(logs) {
        let html = '';
        for (let log of logs) {
          html += `<tr>
                        <td>${log.id}</td>
                        <td>${log.studentId}</td>
                        <td>${log.created}</td>
                        <td>${log.stream}</td>
                        <td>
                          <a class="waves-effect waves-light btn" onclick="deleteLog(${log.id})" href="#logsTable">DELETE</a>
                        </td>
                  </tr>`;
        }
        document.querySelector('#logsTable').innerHTML = html;
      }
      // creates the delete function
      async function deleteLog(id) {
        await sendRequest(`/api/logs/${id}`, 'DELETE');
        getLogs();
      }


    </script>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>

</html>